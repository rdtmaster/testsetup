name: myrelease

on: 
  push:
    tags:
      - '*'

permissions:
  contents: write
  # packages: write
  # issues: write

jobs:
  myrelease:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: git fetch --force --tags
      #- name: change temp dir
        #run: echo "TMPDIR=${{ runner.temp }}" >> $GITHUB_ENV
        shell: bash
      - name: build go-msi
        run: |
          $env:Path += ";d:\a\go-msi;C:\Program Files (x86)\WiX Toolset v3.11\bin"
          $env:TMP = "${{ runner.temp }}"
          $env:Tempdir = "${{ runner.temp }}"
          git clone https://github.com/mh-cbon/go-msi
          cd go-msi 
          go mod init github.com/mh-cbon/go-msi
          go mod tidy -v 
          go build -v
          cd ..
          mkdir d:\a\go-msi
          xcopy /E go-msi d:\a\go-msi
          Remove-Item -Path go-msi -Force -Recurse
          go-msi.exe check-env
          go-msi.exe make -p wix64.json -a amd64 --msi setup-x64.msi --version 1.0.2
          go-msi.exe make -p wix86.json -a 386 --msi setup-x86.msi --version 1.0.2
      - name: build-w64
        run: go build -v -o bin/win64/testsetup.exe
      - name: build-w32
        run: |
          $env:GOARCH="386"
          go build -v -o bin/win32/testsetup.exe
      - name: pack things to zip
        run: |
          7z a testsetup-w64.zip bin/win64/testsetup.exe docs/ examples/
          7z a testsetup-w32.zip bin/win32/testsetup.exe docs/ examples/
      - name: release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            testsetup.exe
            testsetup-w64.zip
            setup-x86.msi
            setup-x64.msi
        #env:
          #GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}