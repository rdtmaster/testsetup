name: myrelease

on: 
  push:
    branches:
      - master

env:
  BIN: testsetup
  EXTRAFILES: docs/ examples/
permissions: write-all

jobs:

  myrelease:
    
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: git fetch --force --tags
      - name: Get Tags
        run: git fetch origin +refs/tags/*:refs/tags/*
      - name: Bump Version
        id: bump_and_tag
        uses: konsentus/action.bump-version-and-tag@v2

      - name: install go-msi
        run: choco install go-msi
  
      - name: build-win-amd64
        run: go build -v -o bin/win64/${{env.BIN}}.exe
      - name: build-win32
        run: |
          $env:GOARCH="386"
          go build -v -o bin/win32/${{env.BIN}}.exe
      - name: build MSIs
        run: |
          $env:Path += ";C:\Program Files\go-msi;C:\Program Files (x86)\WiX Toolset v3.11\bin"
          $env:TMP = "${{ runner.temp }}"
          $env:Tempdir = "${{ runner.temp }}"
          go-msi.exe check-env
          go-msi.exe make -p wix64.json -a amd64 --msi ${{env.BIN}}-setup-amd64.msi --version 1.0.2
          go-msi.exe make -p wix86.json -a 386 --msi ${{env.BIN}}-setup-x86.msi --version 1.0.2
      - name: pack things to zip
        run: |
          7z a ${{env.BIN}}-amd64.zip bin/win64/${{env.BIN}}.exe ${{env.EXTRAFILES}}
          7z a ${{env.BIN}}-x86.zip bin/win32/${{env.BIN.exe}} ${{env.EXTRAFILES}}
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 1.0.0 # Optional fallback tag to use when no tag can be found
      - name: release
        uses: softprops/action-gh-release@v1
        #if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ steps.previoustag.outputs.tag }}
          files: |
            ${{env.BIN}}-amd64.zip
            ${{env.BIN}}-x86.zip
            ${{env.BIN}}-setup-x86.msi
            ${{env.BIN}}-setup-amd64.msi
        #env:
          #GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}